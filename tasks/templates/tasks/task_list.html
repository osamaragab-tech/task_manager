{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task List</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #f8f9fa;
    }

    .card {
        transition: 0.3s;
        border: none;
        border-radius: 12px;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    /* ğŸ”´ Ù…ØªØ£Ø®Ø±Ø© */
    .overdue {
        background: linear-gradient(135deg, #ffe5e5, #ffcccc);
        border-left: 6px solid #dc3545;
    }

    /* ğŸŸ¡ Ø§Ù„ÙŠÙˆÙ… */
    .today {
        background: linear-gradient(135deg, #fff7e0, #ffeeba);
        border-left: 6px solid #ffc107;
    }

    /* ğŸŸ¢ Ù‚Ø§Ø¯Ù…Ø© */
    .upcoming {
        background: linear-gradient(135deg, #e8f8ef, #c7f2d9);
        border-left: 6px solid #198754;
    }

    /* âšª Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® */
    .no-date {
        background: #f1f3f5;
        border-left: 6px solid #6c757d;
    }
</style>
</head>
<body>

<div class="container py-5">
    <h1 class="text-center text-primary mb-4 fw-bold">ğŸ“‹ Task List</h1>

    <!-- ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© -->
    <div id="alerts-container"></div>

    <div class="text-center mb-4">
        <a href="{% url 'task_add' %}" class="btn btn-primary btn-lg shadow">â• Add New Task</a>
    </div>

    {% if tasks %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for task in tasks %}
        <div class="col">
            <div class="card h-100 shadow-sm 
                {% if task.status_label == 'overdue' %}overdue
                {% elif task.status_label == 'today' %}today
                {% elif task.status_label == 'upcoming' %}upcoming
                {% else %}no-date{% endif %}">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-dark">{{ task.title }}</h5>
                    <p class="card-text text-muted">{{ task.description|default:"No description" }}</p>

                    <p class="mb-1"><strong>Created:</strong> {{ task.created_at|date:"d/m/Y H:i" }}</p>
                    {% if task.due_date %}
                    <p class="mb-1"><strong>Due:</strong> {{ task.due_date|date:"d/m/Y" }}</p>
                    {% endif %}

                    {% if task.status_label == 'overdue' %}
                        <p class="text-danger fw-bold">â° Overdue!</p>
                    {% elif task.status_label == 'today' %}
                        <p class="text-warning fw-semibold">âš  Due Today</p>
                    {% endif %}

                    <p class="mb-2"><strong>Status:</strong> 
                        {% if task.status == 'pending' %}
                        <span class="badge bg-warning text-dark">Pending</span>
                        {% else %}
                        <span class="badge bg-success">Done</span>
                        {% endif %}
                    </p>

                    <div>
                        <a href="{% url 'task_edit' task.id %}" class="btn btn-sm btn-outline-primary me-2">Edit</a>
                        <a href="{% url 'task_delete' task.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
        <div class="alert alert-info text-center mt-4">No tasks yet. Add your first task!</div>
    {% endif %}
</div>

<!-- âœ… Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© (ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…) -->
<div class="modal fade" id="todayTasksModal" tabindex="-1" aria-labelledby="todayTasksLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title text-dark fw-bold" id="todayTasksLabel">ğŸ“… Tasks Due Today</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="todayTasksBody">
        <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Got it</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª + Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    const tasks = JSON.parse('{{ tasks_json|safe }}');
    const now = new Date();
    const todayISO = now.toISOString().split("T")[0];
    const alertsContainer = document.getElementById("alerts-container");

    let alertMessages = [];
    let todayTasks = [];

    tasks.forEach(task => {
        if (!task.due_date) return;
        const due = new Date(task.due_date);
        const diff = due - now;

        // ğŸ”¸ Ø¬Ù…Ø¹ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…
        if (task.due_date.startsWith(todayISO)) {
            todayTasks.push(task);
        }

        // â° Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø©
        if (diff > 0 && diff < 3600000) {
            alertMessages.push(`â° Task "<b>${task.title}</b>" is due within the hour.`);
            new Notification("â° Reminder", {
                body: `Task "${task.title}" is due within the hour.`,
                icon: "https://cdn-icons-png.flaticon.com/512/1827/1827279.png"
            });
        }

        // âš  Ù…ØªØ£Ø®Ø±Ø© Ø£Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©
        if (diff < 0 && Math.abs(diff) < 3600000) {
            alertMessages.push(`âš  Task "<b>${task.title}</b>" is now overdue!`);
            new Notification("âš  Overdue Task", {
                body: `Task "${task.title}" is now overdue.`,
                icon: "https://cdn-icons-png.flaticon.com/512/565/565547.png"
            });
        }
    });

    // ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ù†ØµÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©
    if (alertMessages.length > 0) {
        alertsContainer.innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show shadow-sm" role="alert">
                ${alertMessages.join("<br>")}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    // ğŸ“… Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…
    if (todayTasks.length > 0) {
        const modalBody = document.getElementById("todayTasksBody");
        modalBody.innerHTML = `
            <p>You have <b>${todayTasks.length}</b> task(s) due today:</p>
            <ul>${todayTasks.map(t => `<li><strong>${t.title}</strong></li>`).join('')}</ul>
        `;
        const modal = new bootstrap.Modal(document.getElementById('todayTasksModal'));
        modal.show();
    }
});
</script>

</body>
</html>
